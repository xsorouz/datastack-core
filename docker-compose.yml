# ========================================================
# ğŸ§± Stack Data Platform + RAG â€” docker-compose.yml
# Objectif : orchestrer, stocker, analyser, monitorer et enrichir des donnÃ©es
# Cette stack inclut Airflow, MinIO, Trino, Grafana, PostgreSQL, Redis, Metabase, Prometheus, etc.
# Elle peut Ãªtre Ã©tendue via des fichiers docker-compose.override.yml (Airbyte, Spark, Redpanda, MongoDB...)
# ========================================================

# ğŸ”— RÃ©seau privÃ© partagÃ© entre tous les services
networks:
  datastack_net:
    driver: bridge

# ğŸ’¾ Volumes persistants pour stocker les donnÃ©es des services critiques
volumes:
  postgres_data:
  minio_data:
  qdrant_data:
  grafana_data:
  ollama_data:

# â™»ï¸ Variables dâ€™environnement communes Ã  tous les conteneurs Airflow
x-airflow-defaults: &airflow-env
  AIRFLOW__CORE__EXECUTOR: CeleryExecutor
  AIRFLOW__CORE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@stack-postgres/airflow
  AIRFLOW__CELERY__BROKER_URL: redis://stack-redis:6379/0
  AIRFLOW__CELERY__RESULT_BACKEND: db+postgresql://airflow:airflow@stack-postgres/airflow

services:

  # ================================
  # ğŸ—ƒï¸ BASES DE DONNÃ‰ES BACKEND
  # ================================

  # ğŸ“¦ PostgreSQL â€” Stockage des mÃ©tadonnÃ©es Airflow, Metabase et autres
  stack-postgres:
    image: postgres:15
    container_name: stack-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: airflow
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - datastack_net

  # ğŸ” Redis â€” Broker de messages pour exÃ©cuter les tÃ¢ches Airflow via Celery
  stack-redis:
    image: redis:alpine
    container_name: stack-redis
    restart: unless-stopped
    networks:
      - datastack_net

  # ================================
  # â˜ï¸ STOCKAGE OBJETS
  # ================================

  # ğŸª£ MinIO â€” Alternative S3 pour stocker fichiers, dumps, exports, logs, etc.
  stack-minio:
    image: minio/minio
    container_name: stack-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio123
    ports:
      - "9000:9000"   # API S3
      - "9001:9001"   # Console Web
    volumes:
      - minio_data:/data
    networks:
      - datastack_net

  # ================================
  # âš™ï¸ ORCHESTRATION DES FLUX â€” AIRFLOW
  # ================================

  # âš™ï¸ airflow-init â€” Initialisation dâ€™Airflow : DB, compte admin, pip install
  stack-airflow-init:
    build: .
    image: apache/airflow:2.9.0-python3.10
    container_name: stack-airflow-init
    restart: "no"
    depends_on:
      - stack-postgres
      - stack-redis
    environment:
      <<: *airflow-env
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/plugins:/opt/airflow/plugins
      - ./airflow/dbt:/opt/airflow/dbt
      - ./airflow/great_expectations:/opt/airflow/great_expectations
      - ./requirements.txt:/requirements.txt
    entrypoint:
      - bash
      - -c
      - |
        pip install -r /requirements.txt && \
        airflow db init && \
        airflow users create --username admin --firstname Admin --lastname User --role Admin --email admin@example.com --password admin
    networks:
      - datastack_net

  # ğŸŒ Airflow Webserver â€” Interface utilisateur principale (http://localhost:8082)
  stack-airflow-webserver:
    build: .
    image: apache/airflow:2.9.0-python3.10
    container_name: stack-airflow-webserver
    restart: unless-stopped
    depends_on:
      - stack-airflow-init
    environment:
      <<: *airflow-env
    ports:
      - "8082:8080"
    command: webserver
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/logs:/opt/airflow/logs
      - ./airflow/plugins:/opt/airflow/plugins
      - ./airflow/dbt:/opt/airflow/dbt
      - ./airflow/great_expectations:/opt/airflow/great_expectations
      - ./requirements.txt:/requirements.txt
    networks:
      - datastack_net

  # â±ï¸ Scheduler â€” Planifie les DAGs Ã  exÃ©cuter
  stack-airflow-scheduler:
    build: .
    image: apache/airflow:2.9.0-python3.10
    container_name: stack-airflow-scheduler
    restart: unless-stopped
    depends_on:
      - stack-airflow-webserver
    environment:
      <<: *airflow-env
    command: scheduler
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/logs:/opt/airflow/logs
      - ./airflow/plugins:/opt/airflow/plugins
      - ./airflow/dbt:/opt/airflow/dbt
      - ./airflow/great_expectations:/opt/airflow/great_expectations
      - ./requirements.txt:/requirements.txt
    networks:
      - datastack_net

  # ğŸ‘· Worker â€” ExÃ©cute les tÃ¢ches Airflow via Celery
  stack-airflow-worker:
    build: .
    image: apache/airflow:2.9.0-python3.10
    container_name: stack-airflow-worker
    restart: unless-stopped
    depends_on:
      - stack-airflow-scheduler
    environment:
      <<: *airflow-env
    command: celery worker
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/logs:/opt/airflow/logs
      - ./airflow/plugins:/opt/airflow/plugins
      - ./airflow/dbt:/opt/airflow/dbt
      - ./airflow/great_expectations:/opt/airflow/great_expectations
      - ./requirements.txt:/requirements.txt
    networks:
      - datastack_net

  # ğŸŒ¸ Flower â€” UI de monitoring pour les workers Celery (http://localhost:5556)
  stack-flower:
    build: .
    image: apache/airflow:2.9.0-python3.10
    container_name: stack-flower
    restart: unless-stopped
    command: celery flower
    depends_on:
      - stack-redis
      - stack-airflow-worker
    environment:
      <<: *airflow-env
    ports:
      - "5556:5555"
    volumes:
      - ./requirements.txt:/requirements.txt
    networks:
      - datastack_net

  # ================================
  # ğŸ“Š ANALYSE / BI
  # ================================

  # ğŸ“ˆ Metabase â€” Plateforme d'exploration de donnÃ©es et dataviz
  stack-metabase:
    image: metabase/metabase
    container_name: stack-metabase
    restart: unless-stopped
    depends_on:
      - stack-postgres
    ports:
      - "3000:3000"
    networks:
      - datastack_net

  # ğŸ” Trino â€” Moteur SQL fÃ©dÃ©rÃ© (requÃªtes multi-sources)
  stack-trino:
    image: trinodb/trino:latest
    container_name: stack-trino
    restart: unless-stopped
    ports:
      - "8081:8080"
    volumes:
      - ./trino/catalog:/etc/trino/catalog
      - ./trino/etc/core-site.xml:/etc/trino/core-site.xml
    networks:
      - datastack_net

  # ================================
  # ğŸ§  RAG (VECTOR DB + LLM)
  # ================================

  # ğŸ§© Qdrant â€” Base vectorielle pour les embeddings et la recherche sÃ©mantique
  stack-qdrant:
    image: qdrant/qdrant
    container_name: stack-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - datastack_net

  # ğŸ¤– Ollama â€” Serveur dâ€™API locale pour modÃ¨les LLM (Mistral, LLaMA, etc.)
  stack-ollama:
    image: ollama/ollama
    container_name: stack-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - datastack_net

  # ================================
  # ğŸ› ï¸ MONITORING
  # ================================

  # ğŸ“¡ Prometheus â€” Collecte et scrape des mÃ©triques (MinIO, Airflow, etc.)
  stack-prometheus:
    image: prom/prometheus
    container_name: stack-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - datastack_net

  # ğŸ“Š Grafana â€” Visualisation des mÃ©triques Prometheus (http://localhost:3001)
  stack-grafana:
    image: grafana/grafana
    container_name: stack-grafana
    restart: unless-stopped
    depends_on:
      - stack-prometheus
    ports:
      - "3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - datastack_net

  # ================================
  # ğŸŒ REVERSE PROXY CENTRALISÃ‰
  # ================================

  # ğŸ§­ Nginx â€” Reverse proxy unifiÃ© (http://localhost)
  stack-nginx:
    image: nginx:latest
    container_name: stack-nginx
    restart: unless-stopped
    depends_on:
      - stack-airflow-webserver
      - stack-metabase
      - stack-minio
      - stack-grafana
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - datastack_net
